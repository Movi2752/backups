<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="container">
        <h1>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</h1>

        <!-- –ë–õ–û–ö 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
        <div class="section">
            <h2>1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h2>
            <div class="upload-form">
                <div class="form-group">
                    <label for="fileInput">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</label>
                    <input type="file" id="fileInput">
                </div>

                <div class="form-group">
                    <label>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                    <div class="period-inputs">
                        <input type="number" id="periodValue" min="1" value="1" placeholder="1">
                        <select id="periodUnit" onchange="updateMinPeriod()">
                            <option value="seconds">—Å–µ–∫—É–Ω–¥</option>
                            <option value="minutes">–º–∏–Ω—É—Ç</option>
                            <option value="hours" selected>—á–∞—Å–æ–≤</option>
                            <option value="days">–¥–Ω–µ–π</option>
                        </select>
                    </div>
                    <div class="period-help">
                        <small id="periodHelp">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥: 1 —Å–µ–∫—É–Ω–¥–∞</small>
                    </div>
                </div>

                <button class="btn-primary" onclick="uploadFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                <div id="uploadStatus" class="status-message"></div>
            </div>
        </div>

        <!-- –ë–õ–û–ö 2: –ú–æ–∏ —Ñ–∞–π–ª—ã -->
        <div class="section">
            <h2>2. –ú–æ–∏ —Ñ–∞–π–ª—ã</h2>
            <div id="fileList">
                <p class="no-files">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>
            </div>
        </div>

        <!-- –ë–õ–û–ö 3: –ñ—É—Ä–Ω–∞–ª –ª–æ–≥–æ–≤ -->
        <div class="section">
            <h2>3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h2>
            <div class="logs-links">
                <a href="http://localhost:5000" target="_blank" class="btn-log">
                    üìä –ü–µ—Ä–µ–π—Ç–∏ –∫ –∂—É—Ä–Ω–∞–ª—É –ª–æ–≥–æ–≤
                </a>
            </div>
        </div>

        <div class="section">
            <h2>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</h2>
            <div class="logs-links">
                <a href="http://localhost:8002" target="_blank" class="btn-log">
                    üìà –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
                </a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
        function updateMinPeriod() {
            const unit = document.getElementById('periodUnit').value;
            const periodInput = document.getElementById('periodValue');
            const helpText = document.getElementById('periodHelp');

            if (unit === 'seconds') {
                periodInput.min = 30;
                periodInput.value = Math.max(30, parseInt(periodInput.value) || 30);
                helpText.textContent = '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥: 30 —Å–µ–∫—É–Ω–¥';
            } else if (unit === 'minutes') {
                periodInput.min = 1;
                helpText.textContent = '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥: 1 –º–∏–Ω—É—Ç–∞';
            } else if (unit === 'hours') {
                periodInput.min = 1;
                helpText.textContent = '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥: 1 —á–∞—Å';
            } else if (unit === 'days') {
                periodInput.min = 1;
                helpText.textContent = '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥: 1 –¥–µ–Ω—å';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ
        function toMoscowTime(utcTime) {
            if (!utcTime) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            const date = new Date(utcTime);
            return date.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' });
        }

        async function loadFiles() {
            try {
                const res = await fetch(`${API_URL}/files/`);
                const files = await res.json();

                const fileList = document.getElementById('fileList');

                if (files.length === 0) {
                    fileList.innerHTML = '<p class="no-files">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
                    return;
                }

                let html = '';
                files.forEach(file => {
                    const uploadDate = toMoscowTime(file.upload_date);
                    const periodText = getPeriodText(file.period_value, file.period_unit);
                    const lastBackup = file.last_backup ? toMoscowTime(file.last_backup) : '–ù–µ—Ç';

                    // –ï—Å—Ç—å –ª–∏ –±—ç–∫–∞–ø—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
                    const hasBackups = file.backups_history && file.backups_history.length > 0;
                    const backupListId = `backupList_${file.id}`;

                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-header">
                                    <span class="file-name">${file.filename}</span>
                                    <button class="btn-delete" onclick="deleteFile(${file.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>

                                <div class="file-stats">
                                    <div class="stat">
                                        <span class="stat-label">–ó–∞–≥—Ä—É–∂–µ–Ω:</span>
                                        <span class="stat-value">${uploadDate}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:</span>
                                        <span class="stat-value">${periodText}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">–ë—ç–∫–∞–ø–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:</span>
                                        <span class="stat-value">${file.backup_count || 0}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø:</span>
                                        <span class="stat-value">${lastBackup}</span>
                                    </div>
                                </div>

                                ${hasBackups ? `
                                <div class="backups-section">
                                    <button class="btn-toggle" onclick="toggleBackups('${backupListId}')">
                                        <span class="toggle-icon">‚ñº</span>
                                        –ü–æ–∫–∞–∑–∞—Ç—å –±—ç–∫–∞–ø—ã (${file.backups_history.length})
                                    </button>
                                    <div id="${backupListId}" class="backup-list" style="display: none;">
                                        <table class="backup-table">
                                            <thead>
                                                <tr>
                                                    <th>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                                    <th>–î–∞—Ç–∞</th>
                                                    <th>–§–∞–π–ª</th>
                                                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${file.backups_history.map(backup => {
                                                    const backupTime = toMoscowTime(backup.time);
                                                    const backupUrl = `${API_URL}/backups/${backup.date}/${backup.filename}`;
                                                    return `
                                                        <tr>
                                                            <td>${backupTime}</td>
                                                            <td>${backup.date}</td>
                                                            <td>${backup.filename}</td>
                                                            <td>
                                                                <a href="${backupUrl}" target="_blank" class="btn-download">
                                                                    –°–∫–∞—á–∞—Ç—å
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                fileList.innerHTML = html;
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:', e);
                document.getElementById('fileList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</p>';
            }
        }

        function toggleBackups(listId) {
            const list = document.getElementById(listId);
            const button = list.previousElementSibling;
            const icon = button.querySelector('.toggle-icon');

            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.textContent = '‚ñ≤';
                button.classList.add('active');
            } else {
                list.style.display = 'none';
                icon.textContent = '‚ñº';
                button.classList.remove('active');
            }
        }

        function getPeriodText(value, unit) {
            const units = {
                'seconds': {single: '—Å–µ–∫—É–Ω–¥–∞', few: '—Å–µ–∫—É–Ω–¥—ã', many: '—Å–µ–∫—É–Ω–¥'},
                'minutes': {single: '–º–∏–Ω—É—Ç–∞', few: '–º–∏–Ω—É—Ç—ã', many: '–º–∏–Ω—É—Ç'},
                'hours': {single: '—á–∞—Å', few: '—á–∞—Å–∞', many: '—á–∞—Å–æ–≤'},
                'days': {single: '–¥–µ–Ω—å', few: '–¥–Ω—è', many: '–¥–Ω–µ–π'}
            };

            const unitMap = units[unit] || units.hours;
            let textForm = unitMap.many;

            if (value % 10 === 1 && value % 100 !== 11) {
                textForm = unitMap.single;
            } else if ([2,3,4].includes(value % 10) && ![12,13,14].includes(value % 100)) {
                textForm = unitMap.few;
            }

            return `–ö–∞–∂–¥—ã–µ ${value} ${textForm}`;
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const periodValue = parseInt(document.getElementById('periodValue').value);
            const periodUnit = document.getElementById('periodUnit').value;
            const status = document.getElementById('uploadStatus');

            const file = fileInput.files[0];
            if (!file) {
                status.innerHTML = '<span class="error">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>';
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            if (periodUnit === 'seconds' && periodValue < 30) {
                status.innerHTML = '<span class="error">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–µ–∫—É–Ω–¥: 30</span>';
                return;
            }

            if (periodValue < 1) {
                status.innerHTML = '<span class="error">–ü–µ—Ä–∏–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1</span>';
                return;
            }

            status.innerHTML = '<span class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`${API_URL}/upload/?period_value=${periodValue}&period_unit=${periodUnit}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();
                if (result.message) {
                    status.innerHTML = '<span class="success">–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!</span>';
                    fileInput.value = '';
                    loadFiles();

                    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        status.innerHTML = '';
                    }, 3000);
                } else {
                    status.innerHTML = `<span class="error">–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</span>`;
                }
            } catch(e) {
                status.innerHTML = '<span class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞</span>';
                console.error(e);
            }
        }

        async function deleteFile(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) return;

            try {
                const res = await fetch(`${API_URL}/files/${id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.message) {
                    loadFiles();
                } else {
                    alert(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch(e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                console.error(e);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        document.addEventListener('DOMContentLoaded', () => {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateMinPeriod();

            loadFiles();
            setInterval(loadFiles, 10000);
        });
    </script>
</body>
</html>