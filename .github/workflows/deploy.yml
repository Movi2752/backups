# .github/workflows/simple-deploy.yml
name: Simple Build and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Фиксируем имя репозитория в нижнем регистре
  IMAGE_PREFIX: movi2752/course-work

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push all services
        run: |
          # Список всех сервисов
          services=("backend" "worker" "frontend" "logger" "stats")
          
          for service in "${services[@]}"; do
            echo "Building $service..."
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              -t ghcr.io/${{ env.IMAGE_PREFIX }}/${service}:latest \
              -t ghcr.io/${{ env.IMAGE_PREFIX }}/${service}:${{ github.sha }} \
              --push \
              ./${service}
          done

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Deploy using SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
              -u "${{ github.actor }}" \
              --password-stdin
            
            # Create or update docker-stack.yml
            cat > /opt/app/docker-stack.yml << 'EOF'
            version: "3.9"
            services:
              backend:
                image: ghcr.io/${{ env.IMAGE_PREFIX }}/backend:latest
                ports: ["8000:8000"]
                networks: ["app-net"]
                volumes:
                  - /opt/app/uploads:/app/uploads
                  - /opt/app/backups:/app/backups
                  - /opt/app/data:/app/data
                  - /opt/app/logs:/app/logs
                deploy:
                  replicas: 3
                  restart_policy: {condition: on-failure}
                  resources:
                    limits: {cpus: "0.8", memory: 1024M}

              worker:
                image: ghcr.io/${{ env.IMAGE_PREFIX }}/worker:latest
                networks: ["app-net"]
                volumes:
                  - /opt/app/uploads:/app/uploads
                  - /opt/app/backups:/app/backups
                  - /opt/app/data:/app/data
                  - /opt/app/logs:/app/logs
                deploy:
                  replicas: 2
                  restart_policy: {condition: on-failure}
                  resources:
                    limits: {cpus: "0.5", memory: 512M}

              frontend:
                image: ghcr.io/${{ env.IMAGE_PREFIX }}/frontend:latest
                ports: ["80:80"]
                networks: ["app-net"]
                volumes: ["/opt/app/logs:/usr/share/nginx/html/logs"]
                deploy:
                  replicas: 2
                  restart_policy: {condition: on-failure}
                  resources:
                    limits: {cpus: "0.3", memory: 256M}

              logger:
                image: ghcr.io/${{ env.IMAGE_PREFIX }}/logger:latest
                ports: ["5000:5000"]
                networks: ["app-net"]
                volumes: ["/opt/app/logs:/app/logs"]
                deploy:
                  replicas: 1
                  restart_policy: {condition: on-failure}

              stats:
                image: ghcr.io/${{ env.IMAGE_PREFIX }}/stats:latest
                ports: ["8002:8002"]
                networks: ["app-net"]
                volumes:
                  - /opt/app/uploads:/app/uploads
                  - /opt/app/backups:/app/backups
                  - /opt/app/data:/app/data
                  - /opt/app/logs:/app/logs
                deploy:
                  replicas: 1
                  restart_policy: {condition: on-failure}

            networks:
              app-net:
                driver: overlay
            EOF
            
            # Deploy stack
            cd /opt/app
            docker stack deploy -c docker-stack.yml app --with-registry-auth
            
            # Check status
            sleep 20
            docker service ls
